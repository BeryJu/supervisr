before_script:
  - sudo apt-get update >/dev/null
  - sudo apt-get -y install python3-pip python3-dev libsasl2-dev libldap2-dev libssl-dev python3-mysqldb libmysqlclient-dev >/dev/null
  - sudo python3 -m pip install -U -r requirements-dev.txt >/dev/null
  - cd supervisr/
stages:
  - test
  - deploy
migrations:
  type: test
  stage: test
  script:
    - python3 manage.py makemigrations
    - python3 manage.py migrate
unittest:
  type: test
  stage: test
  script:
    - python3 manage.py test
coverage:
  type: test
  stage: test
  script:
    - python3 manage.py makemigrations
    - python3 manage.py migrate
    - coverage run --source='.' manage.py test
    - coverage report
isort:
  type: test
  stage: test
  script:
    - isort -c -vb
pylint:
  type: test
  stage: test
  script:
    - pylint --load-plugins pylint_django supervisr*
prospector:
  type: test
  stage: test
  script:
    - prospector -I migration
deploy:
  type: deploy
  stage: deploy
  only:
    - prod
  script:
    - "eval $(ssh-agent -s)"
    - "mkdir ~/.ssh -p"
    - "echo \"${CI_SSH_PRIVATE}\" | ssh-add -"
    - ssh -o 'StrictHostKeyChecking=no' beryjuorg@prd-web01.prs.fr.beryju.org "./update_supervisr.sh"
  environment:
    name: production
    url: https://my.beryju.org
