# Global Variables
before_script:
  - "python3 -m pip install -U virtualenv"
  - "virtualenv env"
  - "source env/bin/activate"
  - "pip3 install invoke"
  - "inv install --dev"
stages:
  - test
  - test-db
  - build-release
  - deploy
image: python:3.6
variables:
  # Configure mysql environment variables (https://hub.docker.com/r/_/mysql/)
  MYSQL_DATABASE: supervisr_test
  MYSQL_ROOT_PASSWORD: 'EK-5jnKfjrGRm<77'
  POSTGRES_DB: supervisr_test
  POSTGRES_USER: supervisr
  POSTGRES_PASSWORD: 'EK-5jnKfjrGRm<77'

# All normal tests
coverage:
  except:
    - prod
  script:
    - "inv coverage"
  stage: test
  cache:
    paths:
      - env/
isort:
  except:
    - prod
  script:
    - "inv isort"
  stage: test
  cache:
    paths:
      - env/
migrations:
  except:
    - prod
  script:
    - "inv migrate"
  stage: test
  cache:
    paths:
      - env/
prospector:
  except:
    - prod
  script:
    - "inv prospector"
  stage: test
  cache:
    paths:
      - env/
pylint:
  except:
    - prod
  script:
    - "inv lint"
  stage: test
  cache:
    paths:
      - env/
unittest:
  except:
    - prod
  script:
    - "inv unittest"
  stage: test
  cache:
    paths:
      - env/

# Database tests
unittest_mysql:
  services:
    - mysql:latest
  except:
    - prod
  script:
    - pip install pymysql
    - inv migrate
    - inv unittest
  variables:
    SUPERVISR_LOCAL_SETTINGS: supervisr.local_settings_mysql
  stage: test-db
  only:
    - db-*
    - release-*
  cache:
    paths:
      - env/
unittest_pgsql:
  services:
    - postgres:latest
  except:
    - prod
  script:
    - pip install psycopg2
    - inv migrate
    - inv unittest
  variables:
    SUPERVISR_LOCAL_SETTINGS: supervisr.local_settings_pgsql
  stage: test-db
  only:
    - db-*
    - release-*
  cache:
    paths:
      - env/

# Release test
bundle_release:
  script:
    # Build package, upload, etc
    - exit 0
  only:
    - release-*
  stage: build-release

# Deploy
deploy:
  environment:
    name: production
    url: "https://my.beryju.org"
  only:
    - prod
  script:
    - "eval $(ssh-agent -s)"
    - "mkdir ~/.ssh -p"
    - "echo \"${CI_SSH_PRIVATE}\" | ssh-add -"
    - "inv deploy --user=beryjuorg --fqdn=ory1-web-prod-1.ory1.beryju.org"
  stage: deploy
