{% load pick %}
# Supervisr PostgreSQL Configuration

# gpgsql parameters
{% with DB=settings.DATABASES|pick:'dns,powerdns,default' %}
{% if 'postgres' in DB.ENGINE %}
launch+=gpgsql
gpgsql-host={{ DB.HOST }}
gpgsql-port={{ DB.PORT|default:"3306" }}
gpgsql-dbname={{ DB.NAME }}
gpgsql-user={{ DB.USER }}
gpgsql-password={{ DB.PASSWORD }}
{% endif %}
{% endwith %}
gpgsql-dnssec=yes

gpgsql-any-id-query=SELECT * FROM (SELECT `supervisr/dns_record`.`content`, `supervisr/dns_record`.`ttl`, `supervisr/dns_record`.`prio`, `supervisr/dns_record`.`type`, `supervisr/dns_record`.`domain_id`, NOT `supervisr/dns_record`.`enabled` AS disabled, REPLACE(CONCAT(`supervisr/core_product`.`name`, '.', `supervisr/core_domain`.`domain`), '@.', '') as name, `supervisr/dns_record`.`auth` FROM `supervisr/dns_record` JOIN `supervisr/core_product` ON( `supervisr/dns_record`.`product_ptr_id` = `supervisr/core_product`.`product_id`) JOIN `supervisr/core_domain` ON ( `supervisr/dns_record`.`domain_id` = (SELECT `supervisr/dns_zone`.`product_ptr_id` FROM `supervisr/dns_zone` WHERE `supervisr/dns_zone`.`domain_id` = `supervisr/core_domain`.`product_ptr_id`))) AS T WHERE T.disabled=0 and T.name=? and T.domain_id=?
gpgsql-basic-query=SELECT * FROM (SELECT `supervisr/dns_record`.`content`, `supervisr/dns_record`.`ttl`, `supervisr/dns_record`.`prio`, `supervisr/dns_record`.`type`, `supervisr/dns_record`.`domain_id`, NOT `supervisr/dns_record`.`enabled` AS disabled, REPLACE(CONCAT(`supervisr/core_product`.`name`, '.', `supervisr/core_domain`.`domain`), '@.', '') as name, `supervisr/dns_record`.`auth` FROM `supervisr/dns_record` JOIN `supervisr/core_product` ON( `supervisr/dns_record`.`product_ptr_id` = `supervisr/core_product`.`product_id`) JOIN `supervisr/core_domain` ON ( `supervisr/dns_record`.`domain_id` = (SELECT `supervisr/dns_zone`.`product_ptr_id` FROM `supervisr/dns_zone` WHERE `supervisr/dns_zone`.`domain_id` = `supervisr/core_domain`.`product_ptr_id`))) AS T WHERE T.disabled=0 and T.type=? and T.name=?
gpgsql-id-query=SELECT * FROM (SELECT `supervisr/dns_record`.`content`, `supervisr/dns_record`.`ttl`, `supervisr/dns_record`.`prio`, `supervisr/dns_record`.`type`, `supervisr/dns_record`.`domain_id`, NOT `supervisr/dns_record`.`enabled` AS disabled, REPLACE(CONCAT(`supervisr/core_product`.`name`, '.', `supervisr/core_domain`.`domain`), '@.', '') as name, `supervisr/dns_record`.`auth` FROM `supervisr/dns_record` JOIN `supervisr/core_product` ON( `supervisr/dns_record`.`product_ptr_id` = `supervisr/core_product`.`product_id`) JOIN `supervisr/core_domain` ON ( `supervisr/dns_record`.`domain_id` = (SELECT `supervisr/dns_zone`.`product_ptr_id` FROM `supervisr/dns_zone` WHERE `supervisr/dns_zone`.`domain_id` = `supervisr/core_domain`.`product_ptr_id`))) AS T WHERE T.disabled=0 and T.type=? and T.name=? and T.domain_id=?
gpgsql-list-query=SELECT * FROM (SELECT `supervisr/dns_record`.`content`, `supervisr/dns_record`.`ttl`, `supervisr/dns_record`.`prio`, `supervisr/dns_record`.`type`, `supervisr/dns_record`.`domain_id`, NOT `supervisr/dns_record`.`enabled` AS disabled, REPLACE(CONCAT(`supervisr/core_product`.`name`, '.', `supervisr/core_domain`.`domain`), '@.', '') as name, `supervisr/dns_record`.`auth` FROM `supervisr/dns_record` JOIN `supervisr/core_product` ON( `supervisr/dns_record`.`product_ptr_id` = `supervisr/core_product`.`product_id`) JOIN `supervisr/core_domain` ON ( `supervisr/dns_record`.`domain_id` = (SELECT `supervisr/dns_zone`.`product_ptr_id` FROM `supervisr/dns_zone` WHERE `supervisr/dns_zone`.`domain_id` = `supervisr/core_domain`.`product_ptr_id`))) AS T WHERE (T.disabled=0 OR ?) and T.domain_id=? order by T.name, T.type
gpgsql-activate-domain-key-query=update `supervisr/dns_cryptokey` set active=1 where domain_id=(select id from `supervisr/dns_zone` where name=?) and  `supervisr/dns_cryptokey`.id=?
gpgsql-add-domain-key-query=insert into `supervisr/dns_cryptokey` (domain_id, flags, active, content) select id, ?, ?, ? from `supervisr/dns_zone` where name=?
gpgsql-any-query=SELECT * FROM (SELECT `supervisr/dns_record`.`content`, `supervisr/dns_record`.`ttl`, `supervisr/dns_record`.`prio`, `supervisr/dns_record`.`type`, `supervisr/dns_record`.`domain_id`, NOT `supervisr/dns_record`.`enabled` AS disabled, REPLACE(CONCAT(`supervisr/core_product`.`name`, '.', `supervisr/core_domain`.`domain`), '@.', '') as name, `supervisr/dns_record`.`auth` FROM `supervisr/dns_record` JOIN `supervisr/core_product` ON( `supervisr/dns_record`.`product_ptr_id` = `supervisr/core_product`.`product_id`) JOIN `supervisr/core_domain` ON ( `supervisr/dns_record`.`domain_id` = (SELECT `supervisr/dns_zone`.`product_ptr_id` FROM `supervisr/dns_zone` WHERE `supervisr/dns_zone`.`domain_id` = `supervisr/core_domain`.`product_ptr_id`))) AS T WHERE T.disabled=0 and T.name=?
gpgsql-clear-domain-all-keys-query=delete from `supervisr/dns_cryptokey` where domain_id=(select id from `supervisr/dns_zone` where name=?)
gpgsql-clear-domain-all-metadata-query=delete from `supervisr/dns_domainmetadata` where domain_id=(select id from `supervisr/dns_zone` where name=?)
gpgsql-clear-domain-metadata-query=delete from `supervisr/dns_domainmetadata` where domain_id=(select id from `supervisr/dns_zone` where name=?) and `supervisr/dns_domainmetadata`.kind=?
gpgsql-deactivate-domain-key-query=update `supervisr/dns_cryptokey` set active=0 where domain_id=(select id from `supervisr/dns_zone` where name=?) and  `supervisr/dns_cryptokey`.id=?
gpgsql-delete-comment-rrset-query=DELETE FROM `supervisr/dns_comment` WHERE domain_id=? AND name=? AND type=?
gpgsql-delete-comments-query=DELETE FROM `supervisr/dns_comment` WHERE domain_id=?
gpgsql-delete-domain-query=delete from `supervisr/dns_zone` where name=?
gpgsql-delete-empty-non-terminal-query=delete from `supervisr/dns_record` where domain_id=? and name=? and type is null
gpgsql-delete-names-query=delete from `supervisr/dns_record` where domain_id=? and name=?
gpgsql-delete-rrset-query=delete from `supervisr/dns_record` where domain_id=? and name=? and type=?
gpgsql-delete-tsig-key-query=delete from `supervisr/dns_tsigkey` where name=?
gpgsql-delete-zone-query=delete from `supervisr/dns_record` where domain_id=?
gpgsql-get-all-domain-metadata-query=select kind,content from `supervisr/dns_zone`, `supervisr/dns_domainmetadata` where `supervisr/dns_domainmetadata`.domain_id=`supervisr/dns_zone`.id and name=?
gpgsql-get-all-domains-query=select `supervisr/dns_zone`.id, `supervisr/dns_zone`.name, `supervisr/dns_record`.content, `supervisr/dns_zone`.type, `supervisr/dns_zone`.master, `supervisr/dns_zone`.notified_serial, `supervisr/dns_zone`.last_check, `supervisr/dns_zone`.account from `supervisr/dns_zone` LEFT JOIN `supervisr/dns_record` ON `supervisr/dns_record`.domain_id=`supervisr/dns_zone`.id AND `supervisr/dns_record`.type='SOA' AND `supervisr/dns_record`.name=`supervisr/dns_zone`.name WHERE `supervisr/dns_record`.enabled=1 OR ?
gpgsql-get-domain-metadata-query=select content from (`supervisr/dns_zone`, `supervisr/dns_domainmetadata`) JOIN `supervisr/core_product` on (`supervisr/dns_zone`.product_ptr_id=`supervisr/core_product`.product_id) where `supervisr/dns_domainmetadata`.`id`=`supervisr/dns_zone`.`product_ptr_id` and `supervisr/core_product`.`name`=? and `supervisr/dns_domainmetadata`.kind=?
gpgsql-get-order-after-query=select ordername from `supervisr/dns_record` where ordername > ? and domain_id=? and enabled=1 and ordername is not null order by 1 asc limit 1
gpgsql-get-order-before-query=select ordername, name from `supervisr/dns_record` where ordername <= ? and domain_id=? and enabled=1 and ordername is not null order by 1 desc limit 1
gpgsql-get-order-first-query=select ordername from `supervisr/dns_record` where domain_id=? and enabled=1 and ordername is not null order by 1 asc limit 1
gpgsql-get-order-last-query=select ordername, name from `supervisr/dns_record` where ordername != '' and domain_id=? and enabled=1 and ordername is not null order by 1 desc limit 1
gpgsql-get-tsig-key-query=select algorithm, secret from `supervisr/dns_tsigkey` where name=?
gpgsql-get-tsig-keys-query=select name,algorithm, secret from `supervisr/dns_tsigkey`
gpgsql-info-all-master-query=select id,name,master,last_check,notified_serial,type from `supervisr/dns_zone` where type='MASTER'
gpgsql-info-all-slaves-query=select id,name,master,last_check from `supervisr/dns_zone` where type='SLAVE'
gpgsql-info-zone-query=select id,name,master,last_check,notified_serial,type,account from `supervisr/dns_zone` where name=?
gpgsql-insert-comment-query=INSERT INTO `supervisr/dns_comment` (domain_id, name, type, modified_at, account, comment) VALUES (?, ?, ?, ?, ?, ?)
gpgsql-insert-empty-non-terminal-order-query=insert into `supervisr/dns_record` (type,domain_id,NOT enabled as disabled,name,ordername,auth,change_date,content,ttl,prio) values (null,?,0,?,?,?,NULL,NULL,NULL,NULL)
gpgsql-insert-record-query=insert into `supervisr/dns_record` (content,ttl,prio,type,domain_id,NOT enabled as disabled,name,ordername,auth,change_date) values (?,?,?,?,?,?,?,?,?,NULL)
gpgsql-insert-zone-query=insert into `supervisr/dns_zone` (type,name,master,account,last_check,notified_serial) values(?,?,?,?,NULL,NULL)
gpgsql-list-comments-query=SELECT domain_id,name,type,modified_at,account,comment FROM `supervisr/dns_comment` WHERE domain_id=?
gpgsql-list-domain-keys-query=select `supervisr/dns_cryptokey`.id, flags, active, content from (`supervisr/dns_zone`, `supervisr/dns_cryptokey`) JOIN `supervisr/core_product` on (product_ptr_id=product_id)  where `supervisr/dns_cryptokey`.id=`supervisr/dns_zone`.product_ptr_id and `supervisr/core_product`.`name`=?
gpgsql-list-subzone-query=SELECT content,ttl,prio,type,domain_id,NOT enabled as disabled,name,auth FROM `supervisr/dns_record` WHERE enabled=1 and (name=? OR name like ?) and domain_id=?
gpgsql-master-zone-query=select master from `supervisr/dns_zone` where name=? and type='SLAVE'
gpgsql-nullify-ordername-and-update-auth-query=update `supervisr/dns_record` set ordername=NULL,auth=? where domain_id=? and name=? and enabled=1
gpgsql-nullify-ordername-and-update-auth-type-query=update `supervisr/dns_record` set ordername=NULL,auth=? where domain_id=? and name=? and type=? and enabled=1
gpgsql-remove-domain-key-query=delete from `supervisr/dns_cryptokey` where domain_id=(select id from `supervisr/dns_zone` where name=?) and `supervisr/dns_cryptokey`.id=?
gpgsql-remove-empty-non-terminals-from-zone-query=delete from `supervisr/dns_record` where domain_id=? and type is null
gpgsql-search-comments-query=SELECT domain_id,name,type,modified_at,account,comment FROM `supervisr/dns_comment` WHERE name LIKE ? OR comment LIKE ? LIMIT ?
gpgsql-search-records-query=SELECT content,ttl,prio,type,domain_id,NOT enabled as disabled,name,auth FROM `supervisr/dns_record` WHERE name LIKE ? OR content LIKE ? LIMIT ?
gpgsql-set-domain-metadata-query=insert into `supervisr/dns_domainmetadata` (domain_id, kind, content) select id, ?, ? from `supervisr/dns_zone` where name=?
gpgsql-set-tsig-key-query=replace into `supervisr/dns_tsigkey` (name,algorithm,secret) values(?,?,?)
gpgsql-supermaster-query=select account from `supervisr/dns_supermaster` where ip=? and nameserver=?
gpgsql-update-account-query=update `supervisr/dns_zone` set account=? where name=?
gpgsql-update-kind-query=update `supervisr/dns_zone` set type=? where name=?
gpgsql-update-lastcheck-query=update `supervisr/dns_zone` set last_check=? where id=?
gpgsql-update-master-query=update `supervisr/dns_zone` set master=? where name=?
gpgsql-update-ordername-and-auth-query=update `supervisr/dns_record` JOIN `supervisr/core_product` on (product_ptr_id=product_id) set ordername=?,auth=? where domain_id=? and `supervisr/core_product`.`name`=? and enabled=1
gpgsql-update-ordername-and-auth-type-query=update `supervisr/dns_record` set ordername=?,auth=? where domain_id=? and name=? and type=? and enabled=1
gpgsql-update-serial-query=update `supervisr/dns_zone` set notified_serial=? where id=?
gpgsql-zone-lastchange-query=select max(change_date) from `supervisr/dns_record` where domain_id=?
