#!/bin/bash

set -e

. /usr/share/debconf/confmodule
. /usr/share/dbconfig-common/dpkg/postinst.mysql

# you can set the default database encoding to something else
dbc_mysql_createdb_encoding="UTF8"
dbc_generate_include=template:/etc/supervisr/config.d/database.yml
dbc_generate_include_args="-o template_infile=/usr/share/supervisr/database.yml"
dbc_go supervisr "$@"

declare -a services=("supervisr-task-runner.service" "supervisr.service" "supervisr-task-scheduler.service" "supervisr-task-monitor.service")

if [ -z "`getent group supervisr`" ]; then
  addgroup --quiet --system supervisr
fi
if [ -z "`getent passwd supervisr`" ]; then
  echo " * Creating user and group supervisr..."
  adduser --quiet --system --home /usr/share/supervisr --shell /bin/false --ingroup supervisr --disabled-password --disabled-login --gecos "Supervisr User" supervisr
fi
chown -R supervisr: /var/log/supervisr/
chown -R supervisr: /usr/share/supervisr/
chown -R supervisr: /etc/supervisr/
if [ ! -f '/etc/supervisr/secret_key' ]; then
  echo " * Generating Secret Key"
  sv utils.generate-secret-key > /etc/supervisr/secret_key 2> /dev/null
  chown -R supervisr: /etc/supervisr/
  echo " * Running initial migrations..."
  sv manage migrate sessions > /dev/null
fi
chmod 440 /etc/supervisr/secret_key
echo " * Starting Services..."
for service in "${services[@]}"
do
  systemctl enable $service
  systemctl restart $service
done

#DEBHELPER#

